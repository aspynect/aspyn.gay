<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aspyn blog: fixfiles</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="icon" type="image/x-icon" href="/assets/favicon.png">
    <link href="/prism-vsc-dark-plus.css" rel="stylesheet" />
</head>
<body>
    <nav class="badges">
        <div class="left"></divclass>
            <a rel="noreferrer" href="/">
                <img src="/88x31.gif" alt="home" title="my website :D">
            </a>
            <a rel="noreferrer" href="/blog/">
                <img src="/assets/badges/nav/blog.gif" alt="blog" title="my blog :D">
            </a>
            <a rel="noreferrer" href="/fursona/">
                <img src="/assets/badges/nav/fursona.gif" alt="fursona" title="my fursona :3">
            </a>
        </div>
        
        <div class="right">
            <a rel="noreferrer" href="/s/github.html" target="_blank">
                <img src="/assets/badges/links/github.gif" alt="github" title="codeing">
            </a>
            <a rel="noreferrer" href="/s/bsky.html" target="_blank">
                <img src="/assets/badges/links/bsky.gif" alt="bluesky" title="butter fly app">
            </a>
            <a rel="noreferrer" href="/s/ao3.html" target="_blank">
                <img src="/assets/badges/links/ao3.gif" alt="archive of our own" title="silly fanfic">
            </a>
            <a rel="noreferrer" href="/s/youtube.html" target="_blank">
                <img src="/assets/badges/links/youtube.gif" alt="youtube" title="you tube">
            </a>
        </div>
    </nav>
    <main>
        <h1 id="fixfiles-in-discord">fixfiles in discord</h1>
        <h3 id="section">11/29/24</h3>
        <h3 id="words-3438">Words: 3438</h3>
        <p>today i finished implementing my fixfiles feature into <a
        href="https://github.com/aspynect/aspyn-utils" target="_blank">aspyn-utils</a>.</p>
        <h2 id="premise">premise</h2>
        <p>the core of this part of the project is to create a more convenient
        solution to the common problem of someone sending a file that can’t be
        viewed in discord (particularly commonly video and audio).</p>
        <p>formerly, there were two solutions to this problem: 1. download the
        file, use ffmpeg to fix it, send it back in chat 2. tell the person
        sending the file to fix it themselves</p>
        <p>neither of these options are <em>good</em>, especially if anyone
        involved is a mobile user, or not particularly tech savvy in
        general.</p>
        <h2 id="idea">idea</h2>
        <p>discord bots! they’re easily accessible, especially with the recent
        introduction of user-installed apps, which means i can take my tools
        with me wherever i go, and context menu commands, which means i can run
        commands in relation to anybody’s messages, even if the bot is only
        installed to me and not the server.</p>
        <p>the idea started with the simple concept of automating what i would
        do to fix these files myself: 1. download 2. ffmpeg 3. send back. 4.
        ideally, do not interact with the filesystem</p>
        <h2 id="problem">problem</h2>
        <p>i don’t know how to use ffmpeg in python. i’ve never used nor heard
        of what i now know to be “subprocesses” - and wouldn’t figure this out
        for an awfully long time after i originally started this idea. spoiler:
        i was vastly undereducated about a lot of the relevant concepts
        necessary here and didn’t do a great job of teaching myself.</p>
        <h2 id="solutions">solution(s)</h2>
        <h3 id="find-libraries">00 - find libraries</h3>
        <p>naturally, a few months ago, my first google search was “ffmpeg
        python”. long story short, this led me down several rabbit holes that
        only left me more confused than i already was, none of the libraries
        could do what i wanted to do, especially without interacting with the
        filesystem.</p>
        <p>a few more google searches led me to the python library <a
        href="https://pypi.org/project/pillow/" target="_blank">Pillow</a>, a fork of the Python
        Imaging Lirary (PIL). This would only help me with images, and stop
        there in terms of helpfulness, but it’s a start.</p>
        <p>after a few more hours of banging my head into walls and
        documentation, i came out with this:</p>
        <pre><code class="language-py">
<span class="token decorator annotation punctuation">@app_commands<span class="token punctuation">.</span>allowed_installs</span><span class="token punctuation">(</span>guilds<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> users<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@app_commands<span class="token punctuation">.</span>allowed_contexts</span><span class="token punctuation">(</span>guilds<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> dms<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> private_channels<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@tree<span class="token punctuation">.</span>context_menu</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"fixfiles"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fixfiles</span><span class="token punctuation">(</span>interaction<span class="token punctuation">:</span> discord<span class="token punctuation">.</span>Interaction<span class="token punctuation">,</span>  message<span class="token punctuation">:</span> discord<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> interaction<span class="token punctuation">.</span>response<span class="token punctuation">.</span>defer<span class="token punctuation">(</span><span class="token punctuation">)</span>
    images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> attachment <span class="token keyword">in</span> message<span class="token punctuation">.</span>attachments<span class="token punctuation">:</span>
        <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token keyword">await</span> attachment<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> BytesIO<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span> <span class="token keyword">as</span> image_binary<span class="token punctuation">:</span>
                    <span class="token keyword">with</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_binary<span class="token punctuation">)</span> <span class="token keyword">as</span> img<span class="token punctuation">:</span>
                        img <span class="token operator">=</span> img<span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">"RGBA"</span><span class="token punctuation">)</span>
                        <span class="token keyword">with</span> BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> output_buffer<span class="token punctuation">:</span>
                            img<span class="token punctuation">.</span>save<span class="token punctuation">(</span>output_buffer<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"PNG"</span><span class="token punctuation">)</span>
                            output_buffer<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                            discord_file <span class="token operator">=</span> discord<span class="token punctuation">.</span>File<span class="token punctuation">(</span>fp<span class="token operator">=</span>output_buffer<span class="token punctuation">,</span> filename<span class="token operator">=</span><span class="token string">"converted_image.png"</span><span class="token punctuation">)</span>
                            images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>discord_file<span class="token punctuation">)</span>
    <span class="token keyword">await</span> interaction<span class="token punctuation">.</span>followup<span class="token punctuation">.</span>send<span class="token punctuation">(</span>files <span class="token operator">=</span> images<span class="token punctuation">)</span>
        </code></pre>
        <p>to be honest? i don’t understand all of what this is actually doing.
        i’m deferring the interaction response, doing some magic to take the
        images attached to the interacted message and convert them into PNGs,
        and then send them back. this worked! …most of the time … with only
        images. installing the Pillow AVIF extension gave me a little more reach
        with the files i could take as input, but it was having some issues with
        preserving transparency and such, and i was still frustratingly far from
        the thigns i cared the most about - video and audio.</p>
        <p>clearly i need to go back to the drawing board. alas, i was
        thoroughly lost and didn’t even know where to start. until months later,
        this is where the project stagnated.</p>
        <h3 id="ffmpegging">01 - ffmpegging</h3>
        <p>in complaining about the fact that i had been stuck on this problem
        so long, <a href="https://github.com/WamWooWam" target="_blank">my best friend</a>
        presented me with some new concepts that would help be a starting point
        for me to implement this properly, and prompted me to break the problem
        down into smaller parts: 1. launch ffmpeg 2. feed data to ffmpeg 3. pull
        data from ffmpeg</p>
        <p>all without touching the filesystem. they then also introduced me to
        some keywords that would massively help me learn what i need to in order
        to figure this out: - subprocess - stdin/stdout - pipe</p>
        <p>after some short research, i figured out that these were all simple
        concepts. a subprocess allows you to run commands outside of the script,
        stdin/stdout are the systems in place to input and output from programs
        (things i’m already familiar with, just given a name and
        recontextualized), and pipes simply allow you to pass data between
        programs. i now have the concepts, now to put them together.</p>
        <p><em>disclaimer: most of the struggle from this point forward is
        fighting ffmpeg rather than actually trying to figure out the coding
        problem</em></p>
        <p>firstly, i would need to lay out how i want to run this:</p>
        <pre><code class="language-py">
<span class="token keyword">for</span> attachment <span class="token keyword">in</span> message<span class="token punctuation">.</span>attachments<span class="token punctuation">:</span>
    <span class="token keyword">match</span> attachment<span class="token punctuation">.</span>content_type<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">case</span> <span class="token string">"image"</span><span class="token punctuation">:</span>
            <span class="token comment"># process image into readable image</span>
        <span class="token keyword">case</span> <span class="token string">"video"</span><span class="token punctuation">:</span>
            <span class="token comment"># process video into readable video</span>
        <span class="token keyword">case</span> <span class="token string">"audio"</span><span class="token punctuation">:</span>
            <span class="token comment"># process audio into a video with placeholder</span>
        <span class="token keyword">case</span> <span class="token keyword">_</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
<span class="token keyword">await</span> interaction<span class="token punctuation">.</span>followup<span class="token punctuation">.</span>send<span class="token punctuation">(</span>files <span class="token operator">=</span> images<span class="token punctuation">)</span>
        </code></pre>
        <p>by using a switch statement to separate whether the input file is an
        image, a video, an audio, or a file i can’t process, i can write my
        cases for each of these individual problems without them interfering
        with each other.</p>
        <p>the below snippets were my first big steps towards my goal. an ffmpeg
        command showing how to pipe the input and output for an ffmpeg command,
        and python code outlining how to run commands using subprocesses.</p>
        <p><code>ffmpeg -i -f mp3 pipe: -c:a pcm_s16le -f s16le pipe:</code></p>
        <pre><code class="language-py">
<span class="token keyword">from</span> subprocess <span class="token keyword">import</span> run<span class="token punctuation">,</span> PIPE

p <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'grep'</span><span class="token punctuation">,</span> <span class="token string">'f'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> <span>input</span><span class="token operator">=</span><span class="token string">'one\ntwo\nthree\nfour\nfive\nsix'</span>
<span class="token string">', encoding='</span><span class="token builtin">ascii</span>'<span class="token punctuation">)</span>   
        </code></pre>
        <p>after playing with the commands, i discovered that
        <code>-f image2</code> is the option i need to pass in order to get it
        to output a jpeg file. additionally, i discovered that using
        <code>pipe:0</code> for stdin and <code>pipe:1</code> for stdout,
        instead of implicitly defining them with <code>pipe:</code>, i can more
        effectively ensure that everything is going where i want them to. i
        realized that gifs are counted as images in discord, and i don’t want to
        convert them, so i made sure i wouldn’t run this code if a gif was
        encountered. lastly, i set the extension to “jpg” so the file has an
        extension that matches its format.</p>
        <pre><code class="language-py">
<span class="token keyword">case</span> <span class="token string">"image"</span><span class="token punctuation">:</span>
<span class="token keyword">if</span> attachment<span class="token punctuation">.</span>content_type<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"gif"</span><span class="token punctuation">:</span>
    <span class="token keyword">continue</span>
command <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"ffmpeg"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token string">"pipe:0"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"image2"</span><span class="token punctuation">,</span> <span class="token string">"pipe:1"</span><span class="token punctuation">]</span>
extension <span class="token operator">=</span> <span class="token string">"jpg"</span>
        </code></pre>
        <p>next up, video. <a href="https://github.com/char" target="_blank">my girlfriend</a>
        offered this command to start with for making video work in discord:</p>
        <p><code>ffmpeg -i $input -c:v h264 -c:a aac -pix_fmt yuv420p -movflags faststart $output.mp4</code></p>
        <p>after applying this to my pattern and splitting out the command into
        an array, i got a functional piece of code:</p>
        <pre><code class="language-py">
<span class="token keyword">case</span> <span class="token string">"video"</span><span class="token punctuation">:</span>
command <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"ffmpeg"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token string">"pipe:0"</span><span class="token punctuation">,</span> <span class="token string">"-c:v"</span><span class="token punctuation">,</span> <span class="token string">"h264"</span><span class="token punctuation">,</span> <span class="token string">"-c:a"</span><span class="token punctuation">,</span> <span class="token string">"aac"</span><span class="token punctuation">,</span> <span class="token string">"-pix_fmt"</span><span class="token punctuation">,</span> <span class="token string">"yuv420p"</span><span class="token punctuation">,</span> <span class="token string">"-movflags"</span><span class="token punctuation">,</span> <span class="token string">"faststart"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"mp4"</span><span class="token punctuation">,</span> <span class="token string">"pipe:1"</span><span class="token punctuation">]</span>
extension <span class="token operator">=</span> <span class="token string">"mp4"</span>
        </code></pre>
        <p>audio would prove to be deceptively easy after figuring out my video
        solution. because my goal is to turn audio files into videos with a
        placeholder visual for the sake of playback on mobile, i could recycle
        most of the command, adding only a couple options:</p>
        <pre><code class="language-py">
attachment_data <span class="token operator">=</span> <span class="token keyword">await</span> attachment<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
process <span class="token operator">=</span> run<span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token builtin">input</span> <span class="token operator">=</span> attachment_data<span class="token punctuation">,</span> stdout <span class="token operator">=</span> PIPE<span class="token punctuation">)</span>
<span class="token keyword">if</span> process<span class="token punctuation">.</span>returncode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
    discord_file <span class="token operator">=</span> discord<span class="token punctuation">.</span>File<span class="token punctuation">(</span>fp <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">,</span> filename <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"{attachment.filename.split("</span></span><span class="token punctuation">.</span><span class="token string">")[0]}.{extension}"</span><span class="token punctuation">)</span>
    images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>discord_file<span class="token punctuation">)</span>            
        </code></pre>
        <p>the addition of the paramters
        <code>-loop 1 -r 10 -i assets/sus.webp</code> inserts a still image as
        the video channel for the output, particularly at 10 fps defined by
        <code>-r</code>. (note: sus.webp was simply an asset i had readily
        available)</p>
        <p>now, escaping the switch statement, i can start actually processing
        the files. i’ve defined, depending on type: - the command to be run -
        the extension to give the file</p>
        <p><code>discord.Attachment</code> has a <code>.read()</code> method
        that will output its data as a bytes object. thi is the data that i want
        to pass into the <code>input</code> of <code>subprocess.run()</code> for
        my ffmpeg command. If the command runs successfully (and by proxy has a
        <code>.returncode</code> of 0), then i am taking the data outputted in
        the process’s <code>stdout</code> and passing it into a
        <code>BytesIO()</code> object, which can then be passed into a
        <code>discord.File()</code> object. i then append the file to my
        <code>images</code> array (i should probably rename this but oh well)
        and continue back through the loop for the next attachment.</p>
        <pre><code class="language-py">
attachment_data <span class="token operator">=</span> <span class="token keyword">await</span> attachment<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
process <span class="token operator">=</span> run<span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token builtin">input</span> <span class="token operator">=</span> attachment_data<span class="token punctuation">,</span> stdout <span class="token operator">=</span> PIPE<span class="token punctuation">)</span>
<span class="token keyword">if</span> process<span class="token punctuation">.</span>returncode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
    discord_file <span class="token operator">=</span> discord<span class="token punctuation">.</span>File<span class="token punctuation">(</span>fp <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">,</span> filename <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"{attachment.filename.split("</span></span><span class="token punctuation">.</span><span class="token string">")[0]}.{extension}"</span><span class="token punctuation">)</span>
    images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>discord_file<span class="token punctuation">)</span>
        </code></pre>
        <p>lastly, if at the end of the process there is at least one file in
        the <code>images</code> array, the bot follows up on the deferred
        interaction with the fixed files, else it simply says there were no
        files to be fixed.</p>
        <pre><code class="language-py">
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> interaction<span class="token punctuation">.</span>followup<span class="token punctuation">.</span>send<span class="token punctuation">(</span>files <span class="token operator">=</span> images<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> interaction<span class="token punctuation">.</span>followup<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"No files to fix"</span><span class="token punctuation">)</span>
        </code></pre>
        <p>there we go! a finished product. this works all well and good, but it
        can be pushed a little farther.</p>
        <h2 id="optimization-hardware-acceleration">optimization (hardware
        acceleration)</h2>
        <p>once done, my best friend (wam) proposed the idea of hardware
        accelerating the ffmpeg commands using the gpu on the server he is
        graciously allowing me to host my projects on. this has two benefits: 1.
        significantly faster conversions 2. not completely locking up the cpu
        (which is running several different projects) while converting</p>
        <p>in order to do this, we made slightly different parameter lists
        depending on whether the expected gpu device is present or not (so it
        would still work on my machine while testing):</p>
        <pre><code class="language-py">
hardware <span class="token operator">=</span> path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"/dev/dri/renderD128"</span><span class="token punctuation">)</span>
params <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"-vaapi_device"</span><span class="token punctuation">,</span> <span class="token string">"/dev/dri/renderD128"</span><span class="token punctuation">,</span> <span class="token string">"-vf"</span><span class="token punctuation">,</span> <span class="token string">"hwupload,scale_vaapi=w=-2:h='min(720,iw)':format=nv12"</span><span class="token punctuation">,</span> <span class="token string">"-c:v"</span><span class="token punctuation">,</span> <span class="token string">"h264_vaapi"</span><span class="token punctuation">,</span> <span class="token string">"-b:v"</span><span class="token punctuation">,</span> <span class="token string">"1M"</span><span class="token punctuation">]</span> <span class="token keyword">if</span> hardware <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token string">"-c:v"</span><span class="token punctuation">,</span> <span class="token string">"h264"</span><span class="token punctuation">,</span> <span class="token string">"-vf"</span><span class="token punctuation">,</span> <span class="token string">"scale=-2:'min(720,iw)'"</span><span class="token punctuation">]</span>
        </code></pre>
        <p><em>note: wow python’s ternary operators are really mickey
        mouse</em></p>
        <p><em>note2: we also added an option that scales video down to 720p,
        and leaves it be if it’s already smaller than 720p</em></p>
        <p>additionally, we modified the command arrays to accomodate:</p>
        <pre><code class="language-py">
<span class="token keyword">case</span> <span class="token string">"video"</span><span class="token punctuation">:</span>
    command <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"ffmpeg"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token string">"pipe:0"</span><span class="token punctuation">,</span> <span class="token operator">*</span>params<span class="token punctuation">,</span> <span class="token string">"-c:a"</span><span class="token punctuation">,</span> <span class="token string">"aac"</span><span class="token punctuation">,</span> <span class="token string">"-pix_fmt"</span><span class="token punctuation">,</span> <span class="token string">"yuv420p"</span><span class="token punctuation">,</span> <span class="token string">"-movflags"</span><span class="token punctuation">,</span> <span class="token string">"frag_keyframe+empty_moov+faststart"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"mp4"</span><span class="token punctuation">,</span> <span class="token string">"pipe:1"</span><span class="token punctuation">]</span>
    extension <span class="token operator">=</span> <span class="token string">"mp4"</span>
<span class="token keyword">case</span> <span class="token string">"audio"</span><span class="token punctuation">:</span>
    command <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"ffmpeg"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token string">"pipe:0"</span><span class="token punctuation">,</span> <span class="token string">"-loop"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"-r"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token string">"assets/sus.webp"</span><span class="token punctuation">,</span> <span class="token string">"-shortest"</span><span class="token punctuation">,</span> <span class="token operator">*</span>params<span class="token punctuation">,</span> <span class="token string">"-c:a"</span><span class="token punctuation">,</span> <span class="token string">"aac"</span><span class="token punctuation">,</span> <span class="token string">"-pix_fmt"</span><span class="token punctuation">,</span> <span class="token string">"yuv420p"</span><span class="token punctuation">,</span> <span class="token string">"-movflags"</span><span class="token punctuation">,</span> <span class="token string">"frag_keyframe+empty_moov+faststart"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"mp4"</span><span class="token punctuation">,</span> <span class="token string">"pipe:1"</span><span class="token punctuation">]</span>
    extension <span class="token operator">=</span> <span class="token string">"mp4"</span>
        </code></pre>
        <p>and now, these conversions run on the gpu, typically fluxuating at
        ~8x speed!</p>
        <h3 id="guest-message-from-the-guy">guest message from the guy</h3>
        <p>hi! wam here with a lil info on hardware acceleration</p>
        <p>my server is running an intel core i3-3225, a CPU with a whopping 2
        cores which… wasn’t exactly fast in its day and that day was over 10
        years ago. so i knew when aspyn came to me with this idea that i’d need
        to accelerate video encoding in some way, unfortunately that poses some
        problems by itself</p>
        <p>intel quicksync video is a finicky beast at the best of times and one
        thing i’ve come to understand is it doesn’t super enjoy running
        “headless”, as in, without any display attached. as my server exists as
        a dell tower in an attic with a wifi router plonked on top, this posed
        some issues for me.</p>
        <p>attempting to use the regular <code>-c:v h264_qsv</code> returned
        peculiar intel media sdk errors, given i frankly didn’t want to deal
        with intels bullshit that day, and also noting the fact i may eventually
        switch to hardware more appropriate (maybe even with a dedicated GPU) i
        decided to look into VAAPI, the cross-vendor solution for hardware video
        on linux</p>
        <p>naturally, this also didn’t work but it was firmly my fault this
        time. in my stupidity i had installed multiple different VA drivers, and
        ffmpeg was attempting to use the driver for more modern intel graphics
        found on later generations of their CPUs, meanwhile i was stuck needing
        the version that talks to the i965 driver but that was just a case of
        removing one of the conflicting packages. another issue came when it did
        start working, it started putting out video averaging 8-10mbps, which is
        fine in most cases but when we’re limited to 10MB file uploads, hardly
        ideal. this is why there’s an additional 1mbps cap in the hardware
        parameters</p>
        <h2 id="discord-sucks-actually">discord sucks actually</h2>
        <p>so if an attachment doesn’t have a file extension, it doesn’t have a
        content type! fun! so im using <code>python-magic</code> now</p>
        <pre><code class="language-py">
attachment_data <span class="token operator">=</span> <span class="token keyword">await</span> attachment<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
mime <span class="token operator">=</span> magic<span class="token punctuation">.</span>from_buffer<span class="token punctuation">(</span>attachment_data<span class="token punctuation">,</span> mime <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
contentType <span class="token operator">=</span> mime<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
contentExtension <span class="token operator">=</span> mime<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        </code></pre>
        <p>tada extra work to cover discord being stupid yay</p>
        <h2 id="final-code">final code</h2>
        <pre><code class="language-py">

<span class="token decorator annotation punctuation">@app_commands<span class="token punctuation">.</span>allowed_installs</span><span class="token punctuation">(</span>guilds<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> users<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@app_commands<span class="token punctuation">.</span>allowed_contexts</span><span class="token punctuation">(</span>guilds<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> dms<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> private_channels<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@tree<span class="token punctuation">.</span>context_menu</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"fixfiles"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fixfiles</span><span class="token punctuation">(</span>interaction<span class="token punctuation">:</span> discord<span class="token punctuation">.</span>Interaction<span class="token punctuation">,</span>  message<span class="token punctuation">:</span> discord<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> interaction<span class="token punctuation">.</span>response<span class="token punctuation">.</span>defer<span class="token punctuation">(</span><span class="token punctuation">)</span>
    images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    hardware <span class="token operator">=</span> path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"/dev/dri/renderD128"</span><span class="token punctuation">)</span>
    params <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"-vaapi_device"</span><span class="token punctuation">,</span> <span class="token string">"/dev/dri/renderD128"</span><span class="token punctuation">,</span> <span class="token string">"-vf"</span><span class="token punctuation">,</span> <span class="token string">"hwupload,scale_vaapi=w=-2:h='min(720,iw)':format=nv12"</span><span class="token punctuation">,</span> <span class="token string">"-c:v"</span><span class="token punctuation">,</span> <span class="token string">"h264_vaapi"</span><span class="token punctuation">,</span> <span class="token string">"-b:v"</span><span class="token punctuation">,</span> <span class="token string">"1M"</span><span class="token punctuation">]</span> <span class="token keyword">if</span> hardware <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token string">"-c:v"</span><span class="token punctuation">,</span> <span class="token string">"h264"</span><span class="token punctuation">,</span> <span class="token string">"-vf"</span><span class="token punctuation">,</span> <span class="token string">"scale=-2:'min(720,iw)'"</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> attachment <span class="token keyword">in</span> message<span class="token punctuation">.</span>attachments<span class="token punctuation">:</span>
        extension <span class="token operator">=</span> <span class="token string">""</span>
        attachment_data <span class="token operator">=</span> <span class="token keyword">await</span> attachment<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        mime <span class="token operator">=</span> magic<span class="token punctuation">.</span>from_buffer<span class="token punctuation">(</span>attachment_data<span class="token punctuation">,</span> mime <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
        contentType <span class="token operator">=</span> mime<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        contentExtension <span class="token operator">=</span> mime<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">match</span> contentType<span class="token punctuation">:</span>
            <span class="token keyword">case</span> <span class="token string">"image"</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> contentExtension <span class="token operator">==</span> <span class="token string">"gif"</span><span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>
                command <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"ffmpeg"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token string">"pipe:0"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"image2"</span><span class="token punctuation">,</span> <span class="token string">"pipe:1"</span><span class="token punctuation">]</span>
                extension <span class="token operator">=</span> <span class="token string">"jpg"</span>
            <span class="token keyword">case</span> <span class="token string">"video"</span><span class="token punctuation">:</span>
                command <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"ffmpeg"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token string">"pipe:0"</span><span class="token punctuation">,</span> <span class="token operator">*</span>params<span class="token punctuation">,</span> <span class="token string">"-c:a"</span><span class="token punctuation">,</span> <span class="token string">"aac"</span><span class="token punctuation">,</span> <span class="token string">"-pix_fmt"</span><span class="token punctuation">,</span> <span class="token string">"yuv420p"</span><span class="token punctuation">,</span> <span class="token string">"-movflags"</span><span class="token punctuation">,</span> <span class="token string">"frag_keyframe+empty_moov+faststart"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"mp4"</span><span class="token punctuation">,</span> <span class="token string">"pipe:1"</span><span class="token punctuation">]</span>
                extension <span class="token operator">=</span> <span class="token string">"mp4"</span>
            <span class="token keyword">case</span> <span class="token string">"audio"</span><span class="token punctuation">:</span>
                command <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"ffmpeg"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token string">"pipe:0"</span><span class="token punctuation">,</span> <span class="token string">"-loop"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"-r"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token string">"assets/sus.webp"</span><span class="token punctuation">,</span> <span class="token string">"-shortest"</span><span class="token punctuation">,</span> <span class="token operator">*</span>params<span class="token punctuation">,</span> <span class="token string">"-c:a"</span><span class="token punctuation">,</span> <span class="token string">"aac"</span><span class="token punctuation">,</span> <span class="token string">"-pix_fmt"</span><span class="token punctuation">,</span> <span class="token string">"yuv420p"</span><span class="token punctuation">,</span> <span class="token string">"-movflags"</span><span class="token punctuation">,</span> <span class="token string">"frag_keyframe+empty_moov+faststart"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"mp4"</span><span class="token punctuation">,</span> <span class="token string">"pipe:1"</span><span class="token punctuation">]</span>
                extension <span class="token operator">=</span> <span class="token string">"mp4"</span>
            <span class="token keyword">case</span> <span class="token keyword">_</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

        process <span class="token operator">=</span> run<span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token builtin">input</span> <span class="token operator">=</span> attachment_data<span class="token punctuation">,</span> stdout <span class="token operator">=</span> PIPE<span class="token punctuation">)</span>
        <span class="token keyword">if</span> process<span class="token punctuation">.</span>returncode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            discord_file <span class="token operator">=</span> discord<span class="token punctuation">.</span>File<span class="token punctuation">(</span>fp <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">,</span> filename <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"{attachment.filename.split("</span></span><span class="token punctuation">.</span><span class="token string">")[0]}.{extension}"</span><span class="token punctuation">)</span>
            images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>discord_file<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> interaction<span class="token punctuation">.</span>followup<span class="token punctuation">.</span>send<span class="token punctuation">(</span>files <span class="token operator">=</span> images<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> interaction<span class="token punctuation">.</span>followup<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"No files to fix"</span><span class="token punctuation">)</span>

        </code></pre>
        <h2 id="conclusion">conclusion</h2>
        <p>this was an encredibly beneficial project for me, both in terms of my
        own education and the effect it will have going forward. always having
        this tool available to me has already proven to be useful. learning the
        crucial concepts previously outlined (stdi/o, pipes, subprocesses) have
        heightened my understanding of programs and expanded my ability to
        envision how to solve problems on my own.</p>
    </main>
    
    <footer class="badges">
        <a rel="noreferrer" href="/index.html">
            <img src="/88x31.gif" alt="aspyn.gay" title="my website :D">
        </a>
<!--        <a rel="noreferrer" href="/s/twitter.html" target="_blank">
            <img src="/assets/badges/links/twitter.gif" alt="twitter" title="x.com the everything app">
        </a>-->
        <a rel="noreferrer" href="/s/github.html" target="_blank">
            <img src="/assets/badges/links/github.gif" alt="github" title="codeing">
        </a>
        <a rel="noreferrer" href="/s/bsky.html" target="_blank">
            <img src="/assets/badges/links/bsky.gif" alt="bluesky" title="butter fly app">
        </a>
        <a rel="noreferrer" href="/s/ao3.html" target="_blank">
            <img src="/assets/badges/links/ao3.gif" alt="archive of our own" title="silly fanfic">
        </a>
        <a rel="noreferrer" href="/s/youtube.html" target="_blank">
            <img src="/assets/badges/links/youtube.gif" alt="youtube" title="you tube">
        </a>

        <br>

        <a rel="noreferrer" href="https://wamwoowam.co.uk" target="_blank">
            <img src="https://wamwoowam.co.uk/88x31.gif" alt="wam woo wam" title="my bestie's site <3">
        </a>
        <a rel="noreferrer" href="https://kataryn.com" target="_blank">
            <img src="/assets/badges/friends/kataryn.png" alt="kataryn" title="my wife">
        </a>
        <a rel="noreferrer" href="https://kiwis.dev" target="_blank">
            <img src="/assets/badges/friends/kiwi.gif" alt="kiwi" title="kiwi from wii sports">
        </a>
        <a rel="noreferrer" href="https://bsky.app/profile/blipblo.bsky.social" target="_blank">
            <img src="/assets/badges/friends/blipblo.jpg" alt="blipblo" title="blip blo :D">
        </a>

        <br>

        <img src="/assets/badges/other/timewithcat.gif" alt="no time spent with a cat is wasted" title="its true">
        <img src="/assets/badges/other/mikuapproved.gif" alt="miku approved" title="she told me herself">
        <img src="/assets/badges/other/websitegay.gif" alt="this website is gay" title="because i made it">
        <img src="/assets/badges/other/virtualdiva.png" alt="hatsune miku, virtual diva" title="our queen">
        <img src="/assets/badges/other/pridelesbian.gif" alt="lesbian pride" title="i am a lesbian">
        <img src="/assets/badges/other/prideace.gif" alt="asexual pride" title="i am asexual">
        <img src="/assets/badges/other/pridetrans.gif" alt="trans pride" title="i am trans">
        <img src="/assets/badges/other/prideenby.gif" alt="nonbinary pride" title="i am nonbinary">
        <img src="/assets/badges/other/acab.gif" alt="acab" title="acab means all cops">
        <img src="/assets/badges/other/piracy.gif" alt="piracy" title="yeah">
        <img src="/assets/badges/other/ralseidoobie.gif" alt="ralsei smoking a fat doobie" title="ral sei">
        <img src="/assets/badges/other/proud.gif" alt="proud to be me" title="we stand for the flag">
        <img src="/assets/badges/other/transgender.gif" alt="trans your gender" title="do it">
        <img src="/assets/badges/other/transrights.gif" alt="trans rights now" title="pretty please">
    </footer>
</body>
<script src="/kitty/kitty.js"></script>
</html>

